// jquery.kyco.preloader brought to you by www.kyco.co.za. Copyright 2013 Cornelius Weidmann. Distributed under the GPL.
(function(d){var k={init:function(e){var b=d.extend({},{preloadSelector:!0,truePercentage:!0,showInContainer:!1,progressiveReveal:!1,silentMode:!1,debugMode:!1,useOpacity:!1,hidePercentage:!1,loaderText:"loading images, please wait...",animateDuration:0,fadeOutDuration:100,onComplete:function(){}},e);return this.each(function(){function e(){n.forEach(function(a){var p=d('<img src="'+j(a.node)+'" />'),e=!1;p.load(function(){s++;f=b.truePercentage?f+100*(a.fileSize/l):100*(s/l);f=99<f?100:f;t.stop().animate({width:f+ "%"},b.animateDuration,"linear");c.children("span").html(Math.floor(f));s===q&&(n.forEach(function(a){k(a.node)}),t.queue(function(){g.animate({opacity:"0"},b.fadeOutDuration,function(){g.remove();b.onComplete.call(this)})}));b.progressiveReveal&&k(a.node)}).error(function(){if(!e)if(e=!0,b.debugMode){var a=p.attr("src")?p.attr("src"):p.css("backgroundImage");0!==c.find("pre").length?d("<div>Not found: "+a+"</div>").appendTo(c.find("pre")):c.html("Failed loading images:<pre><div>Not found: "+a+"</div></pre>"); c.css("text-align","left")}else c.html("failed loading one or more images... please refresh the page")})})}function j(a){return"none"!==a.css("backgroundImage")?a.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,""):a.attr("src")}function k(a){b.useOpacity?a.css("opacity","1"):a.show()}var h=d(this),u,v=function(a){a=a.children();0<a.length&&a.each(function(){var a=d(this);r.push(a);0<a.children().length&&v(a)})},r=[];0<h.children().length?(b.preloadSelector&&r.push(h),v(h)):b.preloadSelector&& r.push(h);u=r;var n=[],s=0,q=0,f=0,l=0,g=d('<div id="kyco_preloader"></div>');b.showInContainer?(g.appendTo(h),h.css("position","relative"),g.css("position","absolute")):g.appendTo("body");d('<div class="kyco_loader_overlay"></div>').appendTo(g);var m=d('<div class="kyco_loader"></div>').appendTo(g),c=b.hidePercentage?d('<div class="kyco_progress_notification">'+b.loaderText+"</div>").appendTo(m):d('<div class="kyco_progress_notification">'+b.loaderText+' <span class="kyco_progress_percentage">'+ f+"</span>%</div>").appendTo(m),m=d('<div class="kyco_progress_bar"></div>').appendTo(m),t=d('<div class="kyco_progress_loaded"></div>').appendTo(m);b.silentMode&&g.hide();u.forEach(function(a){if(a.is("img")||"none"!==a.css("backgroundImage")){if(!b.preloadSelector||!(b.showInContainer&&a===h))b.useOpacity?a.css("opacity","0"):a.hide();n.push({node:a,fileSize:0});q++}});if(b.truePercentage){var w=0;n.forEach(function(a){d.ajax({type:"HEAD",url:j(a.node),success:function(b,d,c){a.fileSize=parseInt(c.getResponseHeader("Content-Length")); l+=parseInt(c.getResponseHeader("Content-Length"));w++;w===q&&e()},error:function(e){b.debugMode?(404===e.status?0!==c.find("pre").length?d("<div>Not found: "+j(a.node)+"</div>").appendTo(c.find("pre")):c.html("Failed loading images:<pre><div>Not found: "+j(a.node)+"</div></pre>"):0===e.status?0!==c.find("pre").length?d("<div>Invalid cross-domain call: "+j(a.node)+"</div>").appendTo(c.find("pre")):c.html("Failed loading images:<pre><div>Invalid cross-domain call: "+j(a.node)+"</div></pre>"):0!==c.find("pre").length? d("<div>Couldn't get file size, set {truePercentage: false}</div>").appendTo(c.find("pre")):c.html("Failed loading images:<pre><div>Couldn't get file size, set {truePercentage: false}</div></pre>"),c.css("text-align","left")):c.html("failed loading one or more images... please refresh the page")}})})}else l=q,e()})}};d.fn.kycoPreload=function(e){if(k[e])return k[e].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof e||!e)return k.init.apply(this,arguments);d.error("Method "+ e+" does not exist on jQuery.kycoPreload")}})(jQuery);