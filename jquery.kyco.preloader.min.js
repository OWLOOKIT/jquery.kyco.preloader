// jquery.kyco.preloader brought to you by www.kyco.co.za. Copyright 2013 Cornelius Weidmann. Distributed under the GPL.
(function(b){var k={init:function(e){var c=b.extend({},{preloadSelector:!0,truePercentage:!0,showInContainer:!1,progressiveReveal:!1,silentMode:!1,debugMode:!1,useOpacity:!1,hidePercentage:!1,loaderText:"loading images, please wait...",animateDuration:0,fadeOutDuration:100,onComplete:function(){}},e);return this.each(function(){function e(){m.forEach(function(a){var n=b('<img src="'+j(a.node)+'" />'),e=!1;n.load(function(){r++;g=c.truePercentage?g+100*(a.fileSize/l):100*(r/l);g=99<g?100:g;var b=u.width(); s.stop().animate({width:g+"%"},{duration:c.animateDuration,easing:"linear",step:function(){d.children("span").html(Math.floor(100*(s.width()/b)))}});r===p&&(m.forEach(function(a){k(a.node)}),s.queue(function(){f.animate({opacity:"0"},c.fadeOutDuration,function(){f.remove();c.onComplete.call(this)})}));c.progressiveReveal&&k(a.node)}).error(function(){if(!e)if(e=!0,c.debugMode){var a=n.attr("src")?n.attr("src"):n.css("backgroundImage");0!==d.find("pre").length?b("<div>Not found: "+a+"</div>").appendTo(d.find("pre")): d.html("Failed loading images:<pre><div>Not found: "+a+"</div></pre>");d.css("text-align","left")}else d.html("failed loading one or more images... please refresh the page")})})}function j(a){return"none"!==a.css("backgroundImage")?a.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,""):a.attr("src")}function k(a){c.useOpacity?a.css("opacity","1"):a.show()}var h=b(this),v,w=function(a){a=a.children();0<a.length&&a.each(function(){var a=b(this);q.push(a);0<a.children().length&&w(a)})}, q=[];0<h.children().length?(c.preloadSelector&&q.push(h),w(h)):c.preloadSelector&&q.push(h);v=q;var m=[],r=0,p=0,g=0,l=0,f=b('<div id="kyco_preloader"></div>');c.showInContainer?(f.appendTo(h),h.css("position","relative"),f.css("position","absolute")):f.appendTo("body");b('<div class="kyco_loader_overlay"></div>').appendTo(f);var t=b('<div class="kyco_loader"></div>').appendTo(f),d=c.hidePercentage?b('<div class="kyco_progress_notification">'+c.loaderText+"</div>").appendTo(t):b('<div class="kyco_progress_notification">'+ c.loaderText+' <span class="kyco_progress_percentage">'+g+"</span>%</div>").appendTo(t),u=b('<div class="kyco_progress_bar"></div>').appendTo(t),s=b('<div class="kyco_progress_loaded"></div>').appendTo(u);c.silentMode&&f.hide();v.forEach(function(a){if(a.is("img")||"none"!==a.css("backgroundImage")){if(!c.preloadSelector||!(c.showInContainer&&a===h))c.useOpacity?a.css("opacity","0"):a.hide();m.push({node:a,fileSize:0});p++}});if(c.truePercentage){var x=0;m.forEach(function(a){b.ajax({type:"HEAD", url:j(a.node),success:function(b,c,d){a.fileSize=parseInt(d.getResponseHeader("Content-Length"));l+=parseInt(d.getResponseHeader("Content-Length"));x++;x===p&&e()},error:function(e){c.debugMode?(404===e.status?0!==d.find("pre").length?b("<div>Not found: "+j(a.node)+"</div>").appendTo(d.find("pre")):d.html("Failed loading images:<pre><div>Not found: "+j(a.node)+"</div></pre>"):0===e.status?0!==d.find("pre").length?b("<div>Invalid cross-domain call: "+j(a.node)+"</div>").appendTo(d.find("pre")):d.html("Failed loading images:<pre><div>Invalid cross-domain call: "+ j(a.node)+"</div></pre>"):0!==d.find("pre").length?b("<div>Couldn't get file size, set {truePercentage: false}</div>").appendTo(d.find("pre")):d.html("Failed loading images:<pre><div>Couldn't get file size, set {truePercentage: false}</div></pre>"),d.css("text-align","left")):d.html("failed loading one or more images... please refresh the page")}})})}else l=p,e()})}};b.fn.kycoPreload=function(e){if(k[e])return k[e].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof e||!e)return k.init.apply(this, arguments);b.error("Method "+e+" does not exist on jQuery.kycoPreload")}})(jQuery);